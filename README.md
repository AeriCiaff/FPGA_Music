# FPGA电子琴电路
## 开发环境
 - Quartus (Quartus Prime 18.1) Lite Edition
 - Intel MAX 10 10M08SAM153C8G
## 实现功能
 - 通过 `.mif` 文件演奏歌曲
 - 用4x4矩阵键盘设计出电子琴，能够弹奏歌曲
## 1.原理
### 1.1 硬件发声原理、
乐曲中的每一个音符对应着一个确定的频率，想要蜂鸣器发出不同音符的音调，只需要控制FPGA开发板输出相应音符的频率即可。
### 1.2 音符频率的获得
在FPGA开发板上有12MHz的晶振，只需对其进行12分频，即可获得1MHz的基准频率信号。
|音频|C(1)|D(2)|E(3)|F(4)|G(5)|A(6)|B(7)|
|:---|:---|:---|:---|:---|:---|:---|:---|
|中央C|262|296|330|349|392|440|494|
|高音|523|587|659|698|784|880|988|

由此可以算出不同音符对应的预置数

$$
音符的发声频率 = \frac{基准频率}{2 \times (2048 - 预制数)}
$$

对于乐曲中的休止符，只要将预置数设为最大值，为 211-1=2047，即 H7FF，此时扬声器将不会发声。
## 2.模块功能
### 2.1 分频器FDIV
将来自锁相环的 2KHz 分频为 4Hz，提供给 CNT138T 与 RAM 用于控制每一个音符的停留时间，可以根据不同乐谱进行更改。
### 2.2 计数器 CNT138T
这个计数器的计数频率为 4Hz ，即每一个计数值停留时间为 0.25s ，在 4/4 拍的乐谱中，若假设全音符为 1s 则一个四分音符为 0.25s 。可以根据乐曲长度修改计数器的最大计数值。
### 2.3 数控分频模块 SPKER
数控分频模块 SPKER 的功能就是当在输入端给定不同输入数据时，将对输入的时钟信号有不同的分频比，数控分频器就是用计数值可并行预置的加法计数器设计完成的，得出其对应的输出频率。
### 2.4 存储器 ROM_music
music.mif 中的音符数据可以根据演奏乐曲更改。
### 2.5 音乐选择模块select_music
输入端4个输入端口，用来接收不同ROM_music中的音乐，在接收外接信号key，当接收到下降沿时切换歌曲。
### 2.6 模式切换模块select
输入端2个输入端口，分别接入矩阵键盘模块mat_key和音乐选择模块select_music，在接收外界信号开关的不同电平信号时，切换音乐电路或者矩阵键盘电路。
### 2.7 矩阵键盘模块mat_key
由4*4矩阵按键的工作原理知可将矩阵键盘的扫描周期分为 4 个时刻，对应 4 个状态，使得状态机在 4 个状态上循环跳转，最终通过扫描的方式获取矩阵键盘的操作状态。

## 3. 模块组合
### 3.1 模块连接
![1.png](./resources/1.png)
### 3.2 引脚分配
![2.png](./resources/2.png)
